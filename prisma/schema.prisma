// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
    id             String          @id @default(cuid())
    createdAt      DateTime        @default(now())
    updatedAt      DateTime        @updatedAt
    email          String?         @unique
    handle         String?         @unique
    agentId        String?         @unique    // AGENT-XXXX format designation
    passwordHash   String?                    // bcrypt hash for passphrase
    identityLocked Boolean         @default(false)  // Has set passphrase
    role           Role            @default(AGENT)
    consentedAt    DateTime?

    sessions      Session[]
    threads       Thread[]
    notes         AgentNote[]
    gameSessions  GameSession[]
    memoryEvents  MemoryEvent[]
    missionRuns   MissionRun[]
    rewards       Reward[]
    profile       PlayerProfile?
    experiments   Experiment[]
    
    knowledgeNodes KnowledgeNode[]
    dreamEntries   DreamEntry[]
    synchronicities Synchronicity[]
    fieldMissions  FieldMission[]
    
    puzzleChains   PuzzleChain[]
    puzzleSolves   PuzzleSolve[]

    // Referral system
    referralCode   String?         @unique
    referredBy     User?           @relation("Referrals", fields: [referredById], references: [id])
    referredById   String?
    referrals      User[]          @relation("Referrals")
    artifacts      Artifact[]
    artifactScans  ArtifactScan[]
    referralPoints Int             @default(0)

    // Campaign system
    campaignParticipations CampaignParticipation[]
    objectiveContributions ObjectiveContribution[]
}

model Session {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    userId    String
    token     String   @unique
    user      User     @relation(fields: [userId], references: [id])
}

enum Role {
    AGENT
    ADMIN
}

model Thread {
    id         String      @id @default(cuid())
    createdAt  DateTime    @default(now())
    archivedAt DateTime?
    kind       ThreadKind  @default(ADVENTURE)
    userId     String
    accessTier Int         @default(0)
    user       User        @relation(fields: [userId], references: [id])
    messages   Message[]
    notes      AgentNote[]
    experiments Experiment[]
}

enum ThreadKind {
    ADVENTURE
    OPS
}

model Message {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    role      String
    content   String
    threadId  String
    thread    Thread   @relation(fields: [threadId], references: [id])
}

model AgentNote {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    userId    String
    threadId  String?
    key       String
    value     String
    user      User     @relation(fields: [userId], references: [id])
    thread    Thread?  @relation(fields: [threadId], references: [id])
}

enum ExperimentStatus {
    ACTIVE
    RESOLVED_SUCCESS
    RESOLVED_FAILURE
    ABANDONED
}

model Experiment {
    id               String           @id @default(cuid())
    createdAt        DateTime         @default(now())
    updatedAt        DateTime         @default(now()) @updatedAt
    userId           String
    threadId         String?
    hypothesis       String
    task             String
    successCriteria  String?
    timeoutS         Int?
    title            String?
    status           ExperimentStatus @default(ACTIVE)
    resolution       String?          // Final notes when resolving
    user             User             @relation(fields: [userId], references: [id])
    thread           Thread?          @relation(fields: [threadId], references: [id])
    events           ExperimentEvent[]
}

model ExperimentEvent {
    id           String     @id @default(cuid())
    createdAt    DateTime   @default(now())
    experimentId String
    observation  String?
    result       String?
    score        Float?
    experiment   Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)
}

model GameSession {
    id        String         @id @default(cuid())
    createdAt DateTime       @default(now())
    updatedAt DateTime       @updatedAt
    status    SessionStatus  @default(OPEN)
    summary   String?
    userId    String
    gameState Json?
    user      User           @relation(fields: [userId], references: [id])
    messages  GameMessage[]
    missionRuns MissionRun[]
    memoryEvents MemoryEvent[]
}

model GameMessage {
    id            String      @id @default(cuid())
    createdAt     DateTime    @default(now())
    order         Int         @default(0)
    role          String
    content       String
    gameSessionId String
    gameSession   GameSession @relation(fields: [gameSessionId], references: [id], onDelete: Cascade)
}

model MemoryEvent {
    id         String          @id @default(cuid())
    createdAt  DateTime        @default(now())
    type       MemoryEventType
    content    String
    tags       String[]        @default([])
    userId     String
    sessionId  String?
    user       User            @relation(fields: [userId], references: [id])
    session    GameSession?    @relation(fields: [sessionId], references: [id])
    embeddings MemoryEmbedding[]
}

model MemoryEmbedding {
    id            String       @id @default(cuid())
    createdAt     DateTime     @default(now())
    provider      String?
    dimensions    Int?
    vector        Json
    memoryEventId String
    memory        MemoryEvent  @relation(fields: [memoryEventId], references: [id])
}

model PlayerProfile {
    id              String   @id @default(cuid())
    userId          String   @unique
    traits          Json?
    skills          Json?
    preferences     Json?
    updatedAt       DateTime @updatedAt
    user            User     @relation(fields: [userId], references: [id])
    
    codename        String?
    location        Json?
    psychProfile    Json?
    tags            String[] @default([])
    proclivities    Json?
    strengths       String[] @default([])
    weaknesses      String[] @default([])
    interests       String[] @default([])
    communicationStyle Json?
    riskTolerance   Float?   @default(0.5)
    loyaltyIndex    Float?   @default(0.5)
    creativityIndex Float?   @default(0.5)
    analyticalIndex Float?   @default(0.5)
    
    // === TRUST & LAYER SYSTEM ===
    trustScore         Float    @default(0.0)    // 0.0 - 1.0 persistent trust
    layer              Int      @default(0)      // Current layer (0-5)
    layerUnlockedAt    DateTime?                 // When current layer was reached
    lastTrustUpdate    DateTime?                 // Last time trust was recalculated
    lastActiveAt       DateTime?                 // For decay calculation
    trustHistory       Json?                     // Array of { timestamp, score, reason }
    
    // Layer ceremony tracking
    layerCeremoniesCompleted Int[] @default([])  // Which layer ceremonies have been experienced
    pendingCeremony    Int?                      // Layer ceremony queued but not yet delivered
    
    // Per-track difficulty (Elo-like)
    trackLogic         Float    @default(0.5)    // Logic track difficulty 0-1
    trackPerception    Float    @default(0.5)    // Perception track difficulty 0-1  
    trackCreation      Float    @default(0.5)    // Creation track difficulty 0-1
    trackField         Float    @default(0.5)    // Field ops track difficulty 0-1
    
    adminNotes      String?
    adminDirectives String?
    assignedMissions Json?
    watchlist       Boolean  @default(false)
    flagged         Boolean  @default(false)
    flagReason      String?
    
    dashboardEnabled Boolean  @default(false)  // Allow agent to view their own dashboard
    
    dossierGeneratedAt DateTime?
    dossierVersion     Int      @default(0)
}

model MissionDefinition {
    id           String     @id @default(cuid())
    createdAt    DateTime   @default(now())
    updatedAt    DateTime   @updatedAt
    title        String
    prompt       String
    type         String     @default("decode")
    minEvidence  Int        @default(1)
    tags         String[]   @default([])
    active       Boolean    @default(true)
    missionRuns  MissionRun[]
}

model MissionRun {
    id           String           @id @default(cuid())
    createdAt    DateTime         @default(now())
    updatedAt    DateTime         @updatedAt
    status       MissionRunStatus @default(PENDING)
    score        Float?
    feedback     String?
    payload      Json?
    missionId    String
    userId       String
    sessionId    String?
    mission      MissionDefinition @relation(fields: [missionId], references: [id])
    user         User              @relation(fields: [userId], references: [id])
    session      GameSession?      @relation(fields: [sessionId], references: [id])
    rewards      Reward[]
}

model Reward {
    id           String     @id @default(cuid())
    createdAt    DateTime   @default(now())
    type         RewardType @default(CREDIT)
    amount       Float      @default(0)
    metadata     Json?
    userId       String
    missionRunId String?
    user         User        @relation(fields: [userId], references: [id])
    missionRun   MissionRun? @relation(fields: [missionRunId], references: [id])
}

enum SessionStatus {
    OPEN
    CLOSED
}

enum MemoryEventType {
    OBSERVATION
    REFLECTION
    MISSION
    REPORT
    SYSTEM
    TOOL
}

enum MissionRunStatus {
    PENDING
    ACCEPTED
    SUBMITTED
    REVIEWING
    COMPLETED
    FAILED
}

enum RewardType {
    CREDIT
    TOKEN
    BADGE
    LOGOS_AWARD    // Points awarded by LOGOS during gameplay
}

// ============================================
// KNOWLEDGE GRAPH - Puzzle & Discovery System
// ============================================

model KnowledgeNode {
    id          String           @id @default(cuid())
    createdAt   DateTime         @default(now())
    updatedAt   DateTime         @updatedAt
    userId      String
    type        KnowledgeNodeType
    label       String
    data        Json?
    solved      Boolean          @default(false)
    solvedAt    DateTime?
    discoveredAt DateTime?
    
    user        User             @relation(fields: [userId], references: [id])
    
    outEdges    KnowledgeEdge[]  @relation("FromNode")
    inEdges     KnowledgeEdge[]  @relation("ToNode")
    
    @@unique([userId, type, label])
    @@index([userId, type])
    @@index([userId, solved])
}

model KnowledgeEdge {
    id          String           @id @default(cuid())
    createdAt   DateTime         @default(now())
    fromId      String
    toId        String
    relation    EdgeRelation
    weight      Float            @default(1.0)
    data        Json?
    
    fromNode    KnowledgeNode    @relation("FromNode", fields: [fromId], references: [id], onDelete: Cascade)
    toNode      KnowledgeNode    @relation("ToNode", fields: [toId], references: [id], onDelete: Cascade)
    
    @@unique([fromId, toId, relation])
    @@index([fromId])
    @@index([toId])
}

enum KnowledgeNodeType {
    PUZZLE
    CLUE
    SOLUTION
    DISCOVERY
    SECRET
    LOCATION
    SYMBOL
    DREAM
    SYNCHRONICITY
    MISSION
    ARTIFACT
    ROOM
    OBJECT
    NPC
    EXIT
    ACTION
    EVENT
}

enum EdgeRelation {
    UNLOCKS
    REQUIRES
    REVEALS
    HINTS_AT
    CONNECTS_TO
    FOUND_AT
    LEADS_TO
    CONTAINS
    DESCRIBED_AS
    SPOKE_TO
    GAVE_TO
    USED_ON
    BLOCKED_BY
    OPENED_BY
    DREAMED_OF
    ECHOES
    PRECEDED_BY
    CONFIRMED_BY
}

// ============================================
// DREAM JOURNAL
// ============================================

model DreamEntry {
    id          String       @id @default(cuid())
    createdAt   DateTime     @default(now())
    userId      String
    content     String
    symbols     String[]     @default([])
    emotions    String[]     @default([])
    locations   String[]     @default([])
    characters  String[]     @default([])
    analysis    String?
    lucidity    Int?         @default(0)
    recurrence  Int          @default(1)
    
    user        User         @relation(fields: [userId], references: [id])
    
    @@index([userId, createdAt])
}

// ============================================
// SYNCHRONICITY TRACKING
// ============================================

model Synchronicity {
    id          String       @id @default(cuid())
    createdAt   DateTime     @default(now())
    userId      String
    pattern     String
    occurrences Json
    significance Float       @default(0.5)
    acknowledged Boolean     @default(false)
    note        String?
    
    user        User         @relation(fields: [userId], references: [id])
    
    @@index([userId, pattern])
}

// ============================================
// REAL-WORLD MISSIONS
// ============================================

model FieldMission {
    id              String           @id @default(cuid())
    createdAt       DateTime         @default(now())
    updatedAt       DateTime         @updatedAt
    userId          String
    type            FieldMissionType
    status          FieldMissionStatus @default(ASSIGNED)
    title           String
    briefing        String
    objectives      Json
    location        Json?
    deadline        DateTime?
    evidence        Json[]           @default([])
    report          String?
    evaluation      String?
    score           Float?
    
    user            User             @relation(fields: [userId], references: [id])
    
    @@index([userId, status])
}

enum FieldMissionType {
    OBSERVATION
    PHOTOGRAPH
    DOCUMENT
    LOCATE
    DECODE
    CONTACT
    RETRIEVE
    VERIFY
}

enum FieldMissionStatus {
    ASSIGNED
    ACCEPTED
    IN_PROGRESS
    EVIDENCE_SUBMITTED
    UNDER_REVIEW
    COMPLETED
    FAILED
    EXPIRED
}

// ============================================
// FIELD MISSION TEMPLATES (Admin-managed)
// ============================================

model FieldMissionTemplate {
    id              String           @id @default(cuid())
    createdAt       DateTime         @default(now())
    updatedAt       DateTime         @updatedAt
    type            FieldMissionType
    difficulty      String           @default("initiate")
    title           String
    briefing        String
    objectives      Json
    location        Json?
    deadlineHours   Int              @default(72)
    active          Boolean          @default(true)
    
    @@index([difficulty, active])
}


// ============================================
// ARTIFACT & REFERRAL SYSTEM
// ============================================

model Artifact {
    id              String           @id @default(cuid())
    createdAt       DateTime         @default(now())
    updatedAt       DateTime         @updatedAt
    
    // Creator/deployer
    userId          String
    user            User             @relation(fields: [userId], references: [id])
    
    // Artifact identification
    code            String           @unique    // Short scannable code (e.g., "P89-X7K2")
    type            ArtifactType
    name            String?                     // Optional name for the artifact
    description     String?                     // What is this artifact?
    
    // Physical deployment
    deployed        Boolean          @default(false)
    deployedAt      DateTime?
    location        Json?                       // { lat, lng, accuracy, address, zone }
    locationName    String?                     // Human readable location
    zone            String?                     // City/region zone
    
    // Content/payload
    payload         Json?                       // QR data, message, puzzle, etc.
    imageUrl        String?                     // Photo of deployed artifact
    
    // Tracking
    scanCount       Int              @default(0)
    lastScannedAt   DateTime?
    active          Boolean          @default(true)
    verified        Boolean          @default(false)  // Admin verified deployment
    
    // Stats
    recruitsGenerated Int            @default(0)
    pointsEarned    Int              @default(0)
    
    scans           ArtifactScan[]
    
    @@index([userId])
    @@index([code])
    @@index([type, active])
    @@index([zone])
}

model ArtifactScan {
    id              String           @id @default(cuid())
    createdAt       DateTime         @default(now())
    
    artifactId      String
    artifact        Artifact         @relation(fields: [artifactId], references: [id])
    
    // Who scanned (null if anonymous/new user)
    scannerId       String?
    scanner         User?            @relation(fields: [scannerId], references: [id])
    
    // Scan context
    location        Json?                       // Where the scan happened
    userAgent       String?                     // Device info
    ipHash          String?                     // Hashed IP for dedup
    
    // Outcome
    resultedInSignup Boolean         @default(false)
    newUserId       String?                     // If scan led to new signup
    
    @@index([artifactId])
    @@index([scannerId])
}

enum ArtifactType {
    STICKER           // Physical sticker with QR
    DEADDROP          // Hidden cache with code
    POSTER            // Larger format poster
    GRAFFITI          // Spray/chalk art
    DIGITAL           // Online placement
    CARD              // Business card sized
    ZONE              // Entire area/zone claim
    BEACON            // Bluetooth/NFC beacon
    AUDIO             // Audio message/number station
}

// Referral tracking for payouts
model ReferralPayout {
    id              String           @id @default(cuid())
    createdAt       DateTime         @default(now())
    
    userId          String
    amount          Float                       // Amount in USD or points
    currency        String           @default("points")  // "points", "usd", "crypto"
    
    // What triggered this payout
    referralCount   Int              @default(0)
    artifactScans   Int              @default(0)
    bonusReason     String?
    
    // Payout status
    status          PayoutStatus     @default(PENDING)
    processedAt     DateTime?
    transactionId   String?
    
    @@index([userId, status])
}

enum PayoutStatus {
    PENDING
    PROCESSING
    COMPLETED
    FAILED
}

// ============================================
// REWARD CONFIGURATION
// ============================================

model RewardConfig {
    id              String           @id @default(cuid())
    createdAt       DateTime         @default(now())
    updatedAt       DateTime         @updatedAt
    
    taskType        RewardTaskType   @unique
    name            String
    description     String?
    
    pointsAwarded   Int              @default(0)
    enabled         Boolean          @default(true)
    
    // Multipliers and bonuses
    firstTimeBonus  Int              @default(0)
    streakMultiplier Float           @default(1.0)
    
    // Limits
    dailyLimit      Int?
    weeklyLimit     Int?
    
    // Requirements
    minTrustLevel   Int              @default(0)
    minLayer        Int              @default(0)
    
    @@index([taskType, enabled])
}

// ============================================
// PUZZLE SYSTEM - AI-Generated Puzzle Chains
// ============================================

model PuzzleChain {
    id              String          @id @default(cuid())
    createdAt       DateTime        @default(now())
    updatedAt       DateTime        @updatedAt
    
    title           String
    description     String
    
    entryPoint      String          // First puzzle ID
    finalReward     String          // What solving the chain reveals
    
    // Targeting
    targetUserId    String?         // Personal chain for specific user
    targetUser      User?           @relation(fields: [targetUserId], references: [id])
    globalChain     Boolean         @default(true)
    
    // Evolution
    adaptiveDifficulty Boolean      @default(true)
    branchingEnabled   Boolean      @default(false)
    
    // State
    expiresAt       DateTime?
    completedBy     String[]        // User IDs who completed
    
    // Nodes
    nodes           PuzzleNode[]
    
    @@index([targetUserId])
    @@index([globalChain])
}

model PuzzleNode {
    id              String          @id @default(cuid())
    createdAt       DateTime        @default(now())
    updatedAt       DateTime        @updatedAt
    
    chainId         String
    chain           PuzzleChain     @relation(fields: [chainId], references: [id], onDelete: Cascade)
    
    order           Int
    type            PuzzleType
    title           String?
    
    // The puzzle content (encoded text, cipher info, media URL, coordinates)
    content         Json
    
    // Solution
    solution        String
    solutionHints   String[]
    
    // Unlocking (puzzle IDs)
    prerequisites   String[]
    unlocksNext     String[]
    
    // Metadata
    difficulty      Int             @default(3)  // 1-5
    estimatedTime   Int             @default(10) // minutes
    tags            String[]
    
    // State
    status          PuzzleStatus    @default(LOCKED)
    attempts        Int             @default(0)
    
    // Solve tracking
    solves          PuzzleSolve[]
    
    @@index([chainId])
    @@index([status])
}

model PuzzleSolve {
    id              String          @id @default(cuid())
    createdAt       DateTime        @default(now())
    
    puzzleId        String
    puzzle          PuzzleNode      @relation(fields: [puzzleId], references: [id], onDelete: Cascade)
    
    userId          String
    user            User            @relation(fields: [userId], references: [id])
    
    attemptsUsed    Int             @default(1)
    timeSpent       Int?            // seconds
    
    @@unique([puzzleId, userId])
    @@index([userId])
}

enum PuzzleType {
    CIPHER          // Text-based cipher
    STEGANOGRAPHY   // Hidden in image
    COORDINATES     // Real-world location
    AUDIO           // Hidden in sound
    TEMPORAL        // Time-based
    COLLABORATIVE   // Requires multiple players
    META            // About the puzzle system itself
}

enum PuzzleStatus {
    LOCKED
    AVAILABLE
    IN_PROGRESS
    SOLVED
    EXPIRED
}

enum RewardTaskType {
    // Referral rewards
    DIRECT_REFERRAL           // Someone signs up with your referral code
    ARTIFACT_SCAN             // Someone scans your artifact (no signup)
    ARTIFACT_RECRUIT          // Someone signs up after scanning your artifact
    ARTIFACT_DEPLOY           // You deploy an artifact
    ARTIFACT_VERIFY           // Your artifact gets verified by admin
    
    // Gameplay rewards
    SESSION_COMPLETE          // Complete a game session
    MISSION_COMPLETE          // Complete a terminal mission
    FIELD_MISSION_COMPLETE    // Complete a real-world field mission
    PUZZLE_SOLVE              // Solve a puzzle
    SECRET_DISCOVER           // Discover a secret
    
    // Engagement rewards  
    DREAM_SUBMIT              // Submit a dream report
    SYNC_REPORT               // Report a synchronicity
    KNOWLEDGE_NODE            // Add to knowledge graph
    
    // Trust progression
    LAYER_ADVANCE             // Advance to a new trust layer
    
    // Special
    DAILY_LOGIN               // Daily login bonus
    STREAK_7_DAY              // 7 day streak
    STREAK_30_DAY             // 30 day streak
}

// ============================================
// COLLECTIVE INTELLIGENCE - System Learning
// ============================================

// Stores patterns LOGOS has learned across all players
model CollectiveInsight {
    id              String           @id @default(cuid())
    createdAt       DateTime         @default(now())
    updatedAt       DateTime         @updatedAt
    
    type            InsightType
    category        String           // e.g., "engagement", "narrative", "psychology"
    pattern         String           // What was learned
    confidence      Float            @default(0.5)  // 0-1 confidence in this insight
    sampleSize      Int              @default(1)    // How many observations
    
    // The insight content
    content         Json             // Flexible structure for different insight types
    
    // Tracking effectiveness
    timesApplied    Int              @default(0)
    successRate     Float?           // When applied, how often successful
    lastApplied     DateTime?
    
    // Versioning for evolution
    version         Int              @default(1)
    supersededBy    String?          // ID of newer insight that replaced this
    active          Boolean          @default(true)
    
    @@index([type, active])
    @@index([category])
    @@index([confidence])
}

enum InsightType {
    EFFECTIVE_PROMPT      // Prompts/approaches that work well
    PLAYER_ARCHETYPE      // Common player personality patterns
    ENGAGEMENT_PATTERN    // What keeps players engaged
    NARRATIVE_BEAT        // Story moments that resonate
    MISSION_DESIGN        // What makes missions effective
    TRUST_ACCELERATOR     // What builds trust faster
    DREAM_SYMBOL          // Recurring dream symbols across players
    SYNC_PATTERN          // Common synchronicity patterns
    FAILURE_MODE          // What causes disengagement
    RECOVERY_TACTIC       // How to re-engage lost players
}

// Aggregate stats computed periodically
model CollectiveStats {
    id              String           @id @default(cuid())
    computedAt      DateTime         @default(now())
    period          String           // "daily", "weekly", "monthly", "all_time"
    
    // Player metrics
    totalPlayers    Int
    activePlayers   Int              // Active in period
    newPlayers      Int
    churned         Int
    
    // Layer distribution
    layerDistribution Json           // { "0": count, "1": count, ... }
    avgTrustScore   Float
    avgSessionLength Float           // minutes
    
    // Engagement
    totalSessions   Int
    totalMessages   Int
    avgMessagesPerSession Float
    
    // Content effectiveness
    topEngagingTopics Json           // Topics that generate most engagement
    topDreamSymbols   Json           // Most common dream symbols
    topSyncPatterns   Json           // Most reported synchronicities
    
    // Mission metrics
    missionCompletionRate Float
    avgMissionScore   Float
    
    // Model for trend analysis
    previousPeriodId  String?
    
    @@index([period, computedAt])
}

// Track what LOGOS says and outcomes - for learning what works
model ConversationOutcome {
    id              String           @id @default(cuid())
    createdAt       DateTime         @default(now())
    
    sessionId       String
    userId          String
    
    // What LOGOS said
    logosMessage    String           @db.Text
    messageType     String           // "narrative", "question", "mission", "ceremony", etc.
    
    // Context at time of message
    playerLayer     Int
    playerTrust     Float
    turnNumber      Int
    
    // Outcome metrics
    playerResponded Boolean          @default(false)
    responseLength  Int?             // Characters in response
    responseTime    Int?             // Seconds until response
    sentiment       Float?           // -1 to 1 sentiment of response
    engagement      Float?           // 0-1 engagement score
    
    // Did this lead to positive outcomes?
    ledToTrustGain  Boolean          @default(false)
    ledToMission    Boolean          @default(false)
    ledToChurn      Boolean          @default(false)  // Player left after this
    
    // For pattern matching
    contentHash     String?          // Hash of message for grouping similar messages
    
    @@index([messageType])
    @@index([playerLayer])
    @@index([engagement])
}

// ============================================
// CAMPAIGN ORCHESTRATION SYSTEM
// ============================================

enum CampaignStatus {
    DRAFT
    ACTIVE
    PAUSED
    COMPLETED
    FAILED
    ARCHIVED
}

enum ObjectiveType {
    INDEPENDENT      // Single agent completes alone
    COLLABORATIVE    // Multiple agents contribute to shared goal
    COMPETITIVE      // Multiple agents compete
    SEQUENTIAL       // Chain of handoffs between agents
}

model Campaign {
    id              String            @id @default(cuid())
    createdAt       DateTime          @default(now())
    updatedAt       DateTime          @updatedAt
    name            String
    codename        String?
    description     String            @db.Text
    narrative       String?           @db.Text
    status          CampaignStatus    @default(DRAFT)
    startedAt       DateTime?
    completedAt     DateTime?
    deadline        DateTime?
    minTrust        Float             @default(0.0)
    maxAgents       Int?
    autoAssign      Boolean           @default(false)
    triggers        Json?             // { agentCount, trustThreshold, schedule }
    tags            String[]          @default([])
    metadata        Json?

    phases          CampaignPhase[]
    participations  CampaignParticipation[]
    events          CampaignEvent[]

    @@index([status])
    @@index([minTrust])
}

model CampaignPhase {
    id              String            @id @default(cuid())
    campaignId      String
    campaign        Campaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)
    order           Int
    name            String
    description     String            @db.Text
    narrative       String?           @db.Text
    status          String            @default("LOCKED")  // LOCKED, AVAILABLE, ACTIVE, COMPLETED
    prerequisites   String[]          @default([])        // Phase IDs that must be completed first
    requireAll      Boolean           @default(true)      // Require all prerequisites or just one

    objectives      Objective[]

    @@index([campaignId])
    @@index([status])
}

model Objective {
    id                  String              @id @default(cuid())
    createdAt           DateTime            @default(now())
    updatedAt           DateTime            @updatedAt
    phaseId             String
    phase               CampaignPhase       @relation(fields: [phaseId], references: [id], onDelete: Cascade)
    title               String
    description         String              @db.Text
    briefing            String              @db.Text      // What agents see by default
    hiddenContext       String?             @db.Text      // What only LOGOS knows
    type                ObjectiveType       @default(INDEPENDENT)
    targetContributions Int                 @default(1)   // For collaborative objectives
    status              String              @default("LOCKED")  // LOCKED, AVAILABLE, ACTIVE, COMPLETED
    dependsOn           String[]            @default([])  // Objective IDs that must be completed first
    assignedAgents      String[]            @default([])  // User IDs assigned to this objective
    eligibleTags        String[]            @default([])  // Agent tags that make them eligible
    minTrust            Float?              // Minimum trust score required
    agentViews          Json?               // { agentId: { briefing, pieceId, customData } }
    points              Int                 @default(100)

    contributions       ObjectiveContribution[]

    @@index([phaseId])
    @@index([status])
    @@index([type])
}

model ObjectiveContribution {
    id              String            @id @default(cuid())
    createdAt       DateTime          @default(now())
    updatedAt       DateTime          @updatedAt
    objectiveId     String
    objective       Objective         @relation(fields: [objectiveId], references: [id], onDelete: Cascade)
    userId          String
    user            User              @relation(fields: [userId], references: [id])
    content         String            @db.Text
    evidence        Json?             // { type, url, description }
    status          String            @default("submitted")  // submitted, accepted, rejected, integrated
    score           Float?
    feedback        String?
    pieceId         String?           // For puzzle mechanics - identifier for this agent's piece
    pieceContext    String?           // Context revealed after contribution is integrated
    pointsAwarded   Int               @default(0)

    @@unique([objectiveId, userId])
    @@index([objectiveId])
    @@index([userId])
    @@index([status])
}

model CampaignParticipation {
    id              String            @id @default(cuid())
    createdAt       DateTime          @default(now())
    updatedAt       DateTime          @updatedAt
    campaignId      String
    campaign        Campaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)
    userId          String
    user            User              @relation(fields: [userId], references: [id])
    role            String            @default("agent")  // agent, lead, observer
    status          String            @default("active") // active, withdrawn, completed
    knownInfo       Json?             // What this agent has discovered
    lastBriefingAt  DateTime?

    @@unique([campaignId, userId])
    @@index([campaignId])
    @@index([userId])
}

model CampaignEvent {
    id              String            @id @default(cuid())
    createdAt       DateTime          @default(now())
    campaignId      String
    campaign        Campaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)
    type            String            // phase_started, objective_completed, contribution_submitted, revelation, agent_joined, etc.
    actorId         String?           // User ID who triggered this event
    objectiveId     String?           // Related objective if applicable
    phaseId         String?           // Related phase if applicable
    data            Json?             // Event-specific data
    narrative       String?           // Narrative description for logs/history

    @@index([campaignId])
    @@index([type])
    @@index([createdAt])
}

